# Kubernetes Bootstrapping with Kubespray

This directory contains the Ansible configuration for bootstrapping a high-availability Kubernetes cluster using [Kubespray](https://github.com/kubernetes-sigs/kubespray).

## Overview

Kubespray is a production-ready composition of Ansible playbooks, inventory, provisioning tools, and domain knowledge for generic Kubernetes clusters configuration management tasks.

We rely on the inventory generated by Terraform in `inventory/hosts.yml` to define our cluster topology.

## Prerequisites

- **Python**: 3.9+
- **Ansible**: Core >= 2.14
- **SSH Key**: The private key corresponding to the public key injected by Terraform (default: `~/.ssh/id_rsa`).

## Usage

### 1. Install Dependencies

It is recommended to use a virtual environment.

```bash
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

### 2. Verify Inventory

Ensure Terraform has successfully generated the inventory file:

```bash
cat inventory/hosts.yml
```

### 3. Deploy Cluster

Run the main cluster playbook. This will install container runtimes, Kubernetes components, and networking (Calico).

```bash
ansible-playbook -i inventory/hosts.yml --private-key ~/.ssh/id_rsa cluster.yml
```

*Note: This process usually takes 10-20 minutes depending on your network/hardware.*

### 4. Fetch Kubeconfig

Once the cluster is deployed, you can fetch the `admin.conf` to access the cluster.

```bash
ansible-playbook -i inventory/hosts.yml --private-key ~/.ssh/id_rsa fetch-kubeconfig.yml
```

The kubeconfig will be saved to `inventory/artifacts/admin.conf`.

## Operations

### Scaling the Cluster (Adding Nodes)

1.  Update Terraform configuration to increase node count and apply.
2.  Run the scale playbook to join new nodes to the cluster.

```bash
ansible-playbook -i inventory/hosts.yml --private-key ~/.ssh/id_rsa scale.yml
```

### Upgrading Kubernetes

Update the `kube_version` in `inventory/group_vars/k8s_cluster/k8s-cluster.yml` (or via `-e` var) and run:

```bash
ansible-playbook -i inventory/hosts.yml --private-key ~/.ssh/id_rsa upgrade-cluster.yml
```

### Resetting the Cluster (Destructive)

To remove Kubernetes from the nodes (useful for testing/restarting):

```bash
ansible-playbook -i inventory/hosts.yml --private-key ~/.ssh/id_rsa reset.yml
```
